# 影视功能详细分析文档

## 项目概述

本项目是一个基于 FastAPI 后端和 React TypeScript 前端的影视管理应用，主要功能包括电影、电视剧搜索、用户观看状态跟踪、个人影视收藏管理等。

## 核心功能模块

### 1. 影视搜索与发现功能 (`movies.py` + `Home.tsx`)

#### 1.1 后端搜索API (`movies.py`)

**核心端点：**
- `/api/movies/search` - 影视搜索（支持搜索模式和发现模式）
- `/api/movies/genres` - 获取影视分类
- `/api/movies/popular` - 获取热门内容
- `/api/movies/{movie_id}` - 获取影视详情

**搜索功能特性：**

1. **双模式搜索：**
   - 搜索模式：基于关键词搜索，调用TMDB的 `/search/movie`、`/search/tv`、`/search/multi` API
   - 发现模式：基于条件筛选，调用TMDB的 `/discover/movie` 和 `/discover/tv` API

2. **特殊媒体类型支持：**
   - `animation` - 动画电影
   - `anime` - 动漫剧集
   - `documentary` - 纪录片
   - `variety` - 综艺节目
   - `live_action_movie` - 真人电影
   - `live_action_tv` - 真人电视剧

3. **智能过滤系统：**
   - 地区筛选：支持中国大陆、香港、台湾、美国、日本、韩国等
   - 年份筛选：支持年代区间和具体年份
   - 题材筛选：基于TMDB的28种分类映射为中文
   - 排序选项：按热度、评分、上映时间等排序

4. **已标记电影排除功能：**
   - 当用户启用 `excludeMarked` 参数时，系统会：
     - 获取用户已标记的电影ID集合
     - 使用 `fetch_movies_until_enough` 函数智能获取足够的未标记电影
     - 支持多页获取，确保返回20部未标记电影

#### 1.2 前端搜索界面 (`Home.tsx`)

**主要功能：**

1. **搜索状态管理：**
   - 维护搜索模式和热门模式的状态切换
   - 保存当前搜索参数用于翻页和刷新
   - 智能缓存用户观看状态

2. **智能刷新策略：**
   - 当用户标记电影且启用"排除已标记"时，自动从列表移除
   - 当剩余电影少于2部时，自动重新搜索补充内容
   - 延迟执行避免影响UI响应

3. **分页控制：**
   - 支持热门模式和搜索模式的独立分页
   - 智能分页显示（显示当前页周围的页码）
   - 平滑滚动到顶部

### 2. 个人影视管理功能 (`MyMovies.tsx`)

#### 2.1 核心特性

1. **多维度筛选系统：**
   - 观看状态：已看过/想看
   - 媒体类型：电影/电视剧/动画/纪录片等
   - 地区筛选：支持主要国家和地区
   - 题材筛选：动作/喜剧/剧情/惊悚等
   - 年代筛选：按十年分组
   - 自定义背景时间筛选
   - 关键词全文搜索

2. **数据补充功能：**
   - 补充地区信息：`updateProductionCountries()`
   - 补充简介信息：`updateOverview()`
   - 补充导演信息：`updateDirector()`
   - 补充主演信息：`updateCast()`

3. **标签管理系统：**
   - 左侧标签管理面板
   - 支持电影选择和标签编辑
   - 实时同步标签更新

#### 2.2 数据流程

1. **数据加载：**
   ```typescript
   const [watchedMovies, wantToWatchMovies, allMovieEdits] = await Promise.all([
     watchStatusApi.getAll('watched', 1, 1000),
     watchStatusApi.getAll('want_to_watch', 1, 1000),
     movieEditApi.getAll(1, 1000)
   ]);
   ```

2. **筛选逻辑：**
   - 多层级筛选，按顺序应用各种条件
   - 支持复杂的媒体类型识别（基于genres字段）
   - 地区匹配支持多种格式（中文名、英文名、代码）

3. **分页处理：**
   - 前端分页，每页50项
   - 智能分页控件，最多显示10个页码
   - 支持大量数据的高效显示

### 3. 数据模型与存储 (`models.py`)

#### 3.1 核心数据模型

1. **User (用户表):**
   ```python
   - id: 主键
   - username: 用户名（唯一）
   - email: 邮箱（唯一）
   - password_hash: 密码哈希
   - is_admin: 管理员标志
   - created_at: 创建时间
   ```

2. **WatchStatus (观看状态表):**
   ```python
   - id: 主键
   - user_id: 用户ID（外键）
   - movie_id: 电影ID
   - movie_title: 电影标题
   - status: 观看状态（watched/want_to_watch）
   - rating: 评分（1-10）
   - notes: 笔记
   - media_type: 媒体类型（movie/tv）
   - genres: 题材（文本，逗号分隔）
   - production_countries: 出品国家（文本，逗号分隔）
   - director: 导演信息
   - cast: 主演信息
   ```

3. **MovieEdit (电影编辑表):**
   ```python
   - id: 主键
   - user_id: 用户ID（外键）
   - movie_id: 电影ID
   - custom_background_time: 自定义背景时间
   - custom_genre: 自定义题材
   - notes: 备注
   ```

#### 3.2 数据关系

- User ↔ WatchStatus (一对多)
- User ↔ MovieEdit (一对多)
- User ↔ Favorite (一对多)
- 通过 `movie_id` 关联 TMDB 数据

### 4. 外部API集成

#### 4.1 TMDB API集成

1. **API配置：**
   - 基础URL: `https://api.themoviedb.org/3`
   - 图片URL: `https://image.tmdb.org/t/p/w500`
   - 语言设置: `zh-CN`（中文简体）

2. **主要端点使用：**
   - `/search/movie` - 电影搜索
   - `/search/tv` - 电视剧搜索
   - `/search/multi` - 混合搜索
   - `/discover/movie` - 电影发现
   - `/discover/tv` - 电视剧发现
   - `/movie/{id}/credits` - 电影演职人员
   - `/tv/{id}/credits` - 电视剧演职人员

3. **数据处理：**
   - 国家名称中文化映射
   - 题材ID到中文名称转换
   - 演职人员信息提取（导演、主演前5名）

### 5. 用户认证与权限

#### 5.1 认证机制 (`auth.py`)

1. **JWT Token认证：**
   - 使用RS256算法
   - Token有效期7天
   - 自动刷新机制

2. **权限控制：**
   - 可选认证：`get_current_user_optional`
   - 必需认证：`get_current_user`
   - 管理员权限：`require_admin`

#### 5.2 前端认证集成

1. **Token管理：**
   - 存储在localStorage
   - 自动添加到请求头
   - 登录状态同步

2. **权限控制：**
   - 基于用户登录状态显示不同功能
   - 未登录用户可浏览，但不能标记

### 6. API服务层 (`api.ts`)

#### 6.1 核心API模块

1. **movieApi:**
   - `search()` - 电影搜索
   - `getGenres()` - 获取分类
   - `getPopular()` - 获取热门
   - `getDetail()` - 获取详情

2. **watchStatusApi:**
   - `getByMovieId()` - 获取单个观看状态
   - `getAll()` - 获取用户所有观看状态
   - `create()` - 创建观看状态
   - `delete()` - 删除观看状态
   - 数据补充API：`updateProductionCountries()` 等

3. **movieEditApi:**
   - 标签编辑相关API

#### 6.2 错误处理

1. **HTTP拦截器：**
   - 自动添加认证头
   - 统一错误处理
   - 请求重试机制

2. **超时配置：**
   - 连接超时：10秒
   - 总超时：30秒

### 7. 性能优化策略

#### 7.1 后端优化

1. **数据库连接池：**
   - 启用 `pool_pre_ping` 验证连接有效性
   - 设置 `pool_recycle=3600` 每小时回收连接

2. **TMDB API调用优化：**
   - 智能批量获取避免重复请求
   - 异步并发处理提高响应速度

3. **缓存策略：**
   - 演职人员信息缓存
   - 题材映射本地化

#### 7.2 前端优化

1. **数据加载策略：**
   - 并发加载观看状态和编辑记录
   - 智能分页减少内存占用

2. **状态管理优化：**
   - 本地筛选避免频繁API调用
   - 智能刷新策略提升用户体验

### 8. 安全机制

1. **CORS配置：**
   - 限制允许的源地址
   - 支持凭证传递

2. **输入验证：**
   - FastAPI自动参数验证
   - 前端表单验证

3. **认证安全：**
   - 密码哈希存储
   - JWT Token过期控制

## 数据流程图

```
用户操作 → 前端组件 → API服务 → 后端路由 → 业务逻辑 → 数据库/TMDB API
    ↑                                                         ↓
    └── UI更新 ← 状态管理 ← 响应处理 ← API响应 ← 数据处理 ←────┘
```

## 技术栈总结

- **后端：** FastAPI + SQLAlchemy + SQLite + httpx
- **前端：** React + TypeScript + Axios
- **外部服务：** TMDB API
- **认证：** JWT Token
- **数据库：** SQLite（开发）/ PostgreSQL（生产可选）

## 待优化项目

1. 用户认证状态一致性检查
2. 分页逻辑边界条件修复
3. 数据库查询性能改进
4. TMDB API调用错误处理优化
5. 前端组件性能优化
6. 缓存机制完善